//
//  aero_torque.c
//  D-SPOSE
//
//  Created by Luc Sagnieres on 2016-02-29.
//  Copyright Â© 2018 Luc Sagnieres. All rights reserved.
//
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
//% FUNCTION NAME:        aero_torque.c
//%
//% DESCRIPTION:          This function calculates the torque on surface
//%                       due to atmospheric drag for a spinning satellite
//%                       (See Eq. (19) and Appendix B in Sagnieres et al.
//%                       (2018), JGCD)
//%
//% AUTHOR:               Luc Sagnieres
//% DATE:                 February 29, 2016
//% VERSION:              1
//%
//% INPUT:                double rho: atmospheric density (kg m-3)
//%                       double Cd: drag coefficient
//%                       double v[3]: relative wind speed body frame (m s-1)
//%                       double w[3]: relative atmosphere angular
//%                         velocity in body frame (m s-1)
//%                       struct surface geometry: surface geometry
//%
//% OUTPUT:               double g[3]: torque on surface due to atmospheric
//%                         drag in body frame
//%
//% COUPLING:             - surface.h
//%                       - dotprod.c
//%                       - crossprod.c
//%                       - norm.c
//%
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#include <math.h>
#include "aero_torque.h"
#include "surface.h"
#include "dotprod.h"
#include "norm.h"
#include "crossprod.h"

void aero_torque(double rho, double Cd, double v[3], double w[3], struct surface geometry, double g[3]){
    
    for (int i=0; i<3; i++)
        g[i] = 0;
    
    double center_p[3];
    // Calculate center of pressure in body frame
    center_p[0] = (geometry.vertices[0][0] + geometry.vertices[0][1] + geometry.vertices[0][2])/3.0;
    center_p[1] = (geometry.vertices[1][0] + geometry.vertices[1][1] + geometry.vertices[1][2])/3.0;
    center_p[2] = (geometry.vertices[2][0] + geometry.vertices[2][1] + geometry.vertices[2][2])/3.0;
    
    double A = geometry.area;
    
    ////////// FIRST TERM
    double M1[3] = {0,0,0};
    crossprod(center_p, v, M1);
    for (int i=0; i<3; i++)
        M1[i] = M1[i] * rho*geometry.area*dotprod(geometry.normal,v)*Cd/2.0;
    
    ////////// SECOND TERM
    double M2[3] = {0,0,0};
    double J = 0;
    
    if (geometry.normal[0] != 0){
        
        M2[0] = ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/3.0 - ((v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/6.0 - ((v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])))/2.0 - ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - v[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/6.0 - ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])))/4.0 + ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - v[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])))/24.0 + ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/24.0 + ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - v[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/4.0 - ((3*v[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - 3*v[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/18.0 - ((geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0]))*(v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0] + v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/2.0 + (v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])) + ((geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]))*(v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0] + v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/3.0;
        
        M2[1] = ((v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])))/2.0 - ((geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0]))*(v[0]*geometry.vertices[2][0] - v[2]*geometry.vertices[0][0] + v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]))/2.0 + ((v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/6.0 + ((geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]))*(v[0]*geometry.vertices[2][0] - v[2]*geometry.vertices[0][0] + v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]))/3.0 + ((v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/3.0 - ((v[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (v[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/6.0 - (v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])) - ((v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])))/4.0 + ((v[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (v[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])))/24.0 + ((v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/24.0 + ((v[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (v[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/4.0 - ((3*v[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (3*v[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/18.0;
        
        M2[2] = ((v[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (v[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/6.0 - ((v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/6.0 - ((geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]))*(v[0]*geometry.vertices[1][0] - v[1]*geometry.vertices[0][0] + v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]))/3.0 - ((v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/3.0 - ((v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])))/2.0 + (v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])) + ((v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])))/4.0 - ((v[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (v[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])))/24.0 - ((v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/24.0 - ((v[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (v[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/4.0 + ((3*v[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (3*v[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])*(geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]) + geometry.normal[1]*(w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0])))/18.0 + ((geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0]))*(v[0]*geometry.vertices[1][0] - v[1]*geometry.vertices[0][0] + v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]))/2.0;
        
        J = fabs(((geometry.vertices[1][1]-geometry.vertices[1][0])*(geometry.vertices[2][2]-geometry.vertices[2][0]) - (geometry.vertices[1][2]-geometry.vertices[1][0])*(geometry.vertices[2][1]-geometry.vertices[2][0]))/geometry.normal[0]);
        
    }
    
    else if (geometry.normal[1] != 0){
        
        M2[0] = ((geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0]))*(v[1]*geometry.vertices[2][0] - v[2]*geometry.vertices[1][0] + v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]))/2.0 + ((geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]))*(v[1]*geometry.vertices[2][0] - v[2]*geometry.vertices[1][0] + v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]))/3.0 - ((v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/3.0 + ((v[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (v[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/6.0 + (v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])) - ((v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])))/4.0 + ((v[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (v[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])))/24.0 + ((v[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (v[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/24.0 + ((v[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (v[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/4.0 - ((3*v[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (3*v[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/18.0 + ((v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])))/2.0 + ((v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/6.0;
        
        M2[1] = ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - v[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/6.0 - ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/3.0 - ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])))/4.0 + ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - v[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])))/24.0 + ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/24.0 + ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - v[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/4.0 - ((3*v[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - 3*v[0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/18.0 + ((geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0]))*(v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0] + v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/2.0 - (v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])) + ((geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]))*(v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0] + v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/3.0 - ((v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])))/2.0 - ((v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/6.0;
        
        M2[2] = ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/3.0 - ((geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]))*(v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0] + v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]))/3.0 - ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/6.0 + (v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])) + ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])))/4.0 - ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])))/24.0 - ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/24.0 - ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/4.0 + ((3*v[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (3*v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/18.0 + ((v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][1])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][1]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1])))/2.0 + ((v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0])*(geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[2][0] - geometry.vertices[2][2])) - geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]) + geometry.normal[0]*(w[1]*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1])))/6.0 - ((geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0]))*(v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0] + v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]))/2.0;
        
        J = fabs(((geometry.vertices[0][1]-geometry.vertices[0][0])*(geometry.vertices[2][2]-geometry.vertices[2][0]) - (geometry.vertices[0][2]-geometry.vertices[0][0])*(geometry.vertices[2][1]-geometry.vertices[2][0]))/geometry.normal[1]);
        
    }
    
    else if (geometry.normal[2] != 0){
        
        M2[0] = ((geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]))*(v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0] + v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]))/3.0 + ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/3.0 - ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (v[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/6.0 + (v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])) - ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])))/4.0 + ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (v[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])))/24.0 + ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/24.0 + ((v[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (v[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/4.0 - ((3*v[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (3*v[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/18.0 - ((v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])))/2.0 - ((v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/6.0 - ((geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0]))*(v[2]*geometry.vertices[1][0] - v[1]*geometry.vertices[2][0] + v[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (v[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]))/2.0;
        
        M2[1] = ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/6.0 - ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/3.0 - ((geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]))*(v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0] + v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]))/3.0 - (v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])) + ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])))/4.0 - ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])))/24.0 - ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/24.0 - ((v[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/4.0 + ((3*v[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (3*v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/18.0 + ((v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])))/2.0 + ((v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/6.0 + ((geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0]))*(v[2]*geometry.vertices[0][0] - v[0]*geometry.vertices[2][0] + v[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (v[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]))/2.0;
        
        M2[2] = ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/3.0 - ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - v[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])))/6.0 - ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])))/4.0 + ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - v[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])))/24.0 + ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/24.0 + ((v[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - v[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/4.0 - ((3*v[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - 3*v[0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/18.0 - ((geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0]))*(v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0] + v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/2.0 + (v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0])*(geometry.normal[2]*(w[1]*geometry.vertices[0][0] - w[0]*geometry.vertices[1][0]) - geometry.normal[1]*(w[2]*geometry.vertices[0][0] - w[0]*geometry.vertices[2][0]) + geometry.normal[0]*(w[2]*geometry.vertices[1][0] - w[1]*geometry.vertices[2][0])) + ((geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]))*(v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0] + v[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - v[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/3.0 - ((v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][1])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2])))/2.0 - ((v[1]*geometry.vertices[0][0] - v[0]*geometry.vertices[1][0])*(geometry.normal[2]*(w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - w[0]*(geometry.vertices[1][0] - geometry.vertices[1][2])) - geometry.normal[1]*(w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]) + geometry.normal[0]*(w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2])))/6.0;
        
        J = fabs(((geometry.vertices[0][1]-geometry.vertices[0][0])*(geometry.vertices[1][2]-geometry.vertices[1][0])-(geometry.vertices[0][2]-geometry.vertices[0][0])*(geometry.vertices[1][1]-geometry.vertices[1][0]))/geometry.normal[2]);
        
    }
    
    for (int i=0; i<3; i++)
        M2[i] = M2[i]*rho*J*Cd/2.0;
    
    ////////// THIRD TERM
    double M3[3] = {0,0,0};
    
    if (geometry.normal[0] != 0){
        
        M3[0] = (w[0]*(2*geometry.vertices[1][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + 2*geometry.vertices[2][0]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/6.0 + (w[0]*(2*geometry.vertices[1][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + 2*geometry.vertices[2][0]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/6.0 - (w[0]*(pow((geometry.vertices[1][0] - geometry.vertices[1][1]),2) + pow((geometry.vertices[2][0] - geometry.vertices[2][1]),2)))/12.0 - (w[0]*(pow((geometry.vertices[1][0] - geometry.vertices[1][2]),2) + pow((geometry.vertices[2][0] - geometry.vertices[2][2]),2)))/12.0 - (w[0]*(2*(geometry.vertices[1][0] - geometry.vertices[1][1])*(geometry.vertices[1][0] - geometry.vertices[1][2]) + 2*(geometry.vertices[2][0] - geometry.vertices[2][1])*(geometry.vertices[2][0] - geometry.vertices[2][2])))/24.0 - (w[0]*(pow(geometry.vertices[1][0],2) + pow(geometry.vertices[2][0],2)))/2.0 + (w[1]*geometry.vertices[0][0]*geometry.vertices[1][0])/2.0 + (w[2]*geometry.vertices[0][0]*geometry.vertices[2][0])/2.0 - (w[1]*geometry.vertices[0][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))/6.0 - (w[1]*geometry.vertices[0][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))/6.0 - (w[2]*geometry.vertices[0][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))/6.0 - (w[2]*geometry.vertices[0][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))/6.0 + (w[1]*geometry.vertices[1][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/(6*geometry.normal[0]) + (w[1]*geometry.vertices[1][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/(6*geometry.normal[0]) + (w[2]*geometry.vertices[2][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/(6*geometry.normal[0]) + (w[2]*geometry.vertices[2][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/(6*geometry.normal[0]) - (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[1][0] - geometry.vertices[1][1]))/(12*geometry.normal[0]) - (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[1][0] - geometry.vertices[1][2]))/(24*geometry.normal[0]) - (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[1][0] - geometry.vertices[1][1]))/(24*geometry.normal[0]) - (w[1]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[1][0] - geometry.vertices[1][2]))/(12*geometry.normal[0]) - (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[2][0] - geometry.vertices[2][1]))/(12*geometry.normal[0]) - (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[2][0] - geometry.vertices[2][2]))/(24*geometry.normal[0]) - (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[2][0] - geometry.vertices[2][1]))/(24*geometry.normal[0]) - (w[2]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[2][0] - geometry.vertices[2][2]))/(12*geometry.normal[0]);
        
        M3[1] = (w[1]*(2*geometry.vertices[2][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) - (2*geometry.vertices[0][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]))/6.0 - (w[1]*(pow((geometry.vertices[2][0] - geometry.vertices[2][2]),2) + pow((geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])),2)/pow(geometry.normal[0],2)))/12.0 - (w[1]*(pow((geometry.vertices[2][0] - geometry.vertices[2][1]),2) + pow((geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])),2)/pow(geometry.normal[0],2)))/12.0 + (w[1]*(2*geometry.vertices[2][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) - (2*geometry.vertices[0][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]))/6.0 - (w[1]*(pow(geometry.vertices[0][0],2) + pow(geometry.vertices[2][0],2)))/2.0 - (w[1]*(2*(geometry.vertices[2][0] - geometry.vertices[2][1])*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (2*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/pow(geometry.normal[0],2)))/24.0 + (w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1])*(geometry.vertices[2][0] - geometry.vertices[2][1]))/12.0 + (w[2]*(geometry.vertices[1][0] - geometry.vertices[1][1])*(geometry.vertices[2][0] - geometry.vertices[2][2]))/24.0 + (w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2])*(geometry.vertices[2][0] - geometry.vertices[2][1]))/24.0 + (w[2]*(geometry.vertices[1][0] - geometry.vertices[1][2])*(geometry.vertices[2][0] - geometry.vertices[2][2]))/12.0 + (w[0]*geometry.vertices[0][0]*geometry.vertices[1][0])/2.0 + (w[2]*geometry.vertices[1][0]*geometry.vertices[2][0])/2.0 - (w[0]*geometry.vertices[0][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))/6.0 - (w[0]*geometry.vertices[0][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))/6.0 - (w[2]*geometry.vertices[2][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))/6.0 - (w[2]*geometry.vertices[2][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))/6.0 - (w[2]*geometry.vertices[1][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))/6.0 - (w[2]*geometry.vertices[1][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))/6.0 + (w[0]*geometry.vertices[1][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/(6*geometry.normal[0]) + (w[0]*geometry.vertices[1][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/(6*geometry.normal[0]) - (w[0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[1][0] - geometry.vertices[1][1]))/(12*geometry.normal[0]) - (w[0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[1][0] - geometry.vertices[1][2]))/(24*geometry.normal[0]) - (w[0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[1][0] - geometry.vertices[1][1]))/(24*geometry.normal[0]) - (w[0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[1][0] - geometry.vertices[1][2]))/(12*geometry.normal[0]);
        
        M3[2] = (w[2]*(2*geometry.vertices[1][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - (2*geometry.vertices[0][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[0]))/6.0 - (w[2]*(pow((geometry.vertices[1][0] - geometry.vertices[1][2]),2) + pow((geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])),2)/pow(geometry.normal[0],2)))/12.0 - (w[2]*(pow((geometry.vertices[1][0] - geometry.vertices[1][1]),2) + pow((geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])),2)/pow(geometry.normal[0],2)))/12.0 + (w[2]*(2*geometry.vertices[1][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - (2*geometry.vertices[0][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[0]))/6.0 - (w[2]*(2*(geometry.vertices[1][0] - geometry.vertices[1][1])*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (2*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/pow(geometry.normal[0],2)))/24.0 - (w[2]*(pow(geometry.vertices[0][0],2) + pow(geometry.vertices[1][0],2)))/2.0 + (w[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])*(geometry.vertices[2][0] - geometry.vertices[2][1]))/12.0 + (w[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])*(geometry.vertices[2][0] - geometry.vertices[2][2]))/24.0 + (w[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])*(geometry.vertices[2][0] - geometry.vertices[2][1]))/24.0 + (w[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])*(geometry.vertices[2][0] - geometry.vertices[2][2]))/12.0 + (w[0]*geometry.vertices[0][0]*geometry.vertices[2][0])/2.0 + (w[1]*geometry.vertices[1][0]*geometry.vertices[2][0])/2.0 - (w[0]*geometry.vertices[0][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))/6.0 - (w[0]*geometry.vertices[0][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))/6.0 - (w[1]*geometry.vertices[2][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))/6.0 - (w[1]*geometry.vertices[2][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))/6.0 - (w[1]*geometry.vertices[1][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))/6.0 - (w[1]*geometry.vertices[1][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))/6.0 + (w[0]*geometry.vertices[2][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/(6*geometry.normal[0]) + (w[0]*geometry.vertices[2][0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/(6*geometry.normal[0]) - (w[0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[2][0] - geometry.vertices[2][1]))/(12*geometry.normal[0]) - (w[0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[2][0] - geometry.vertices[2][2]))/(24*geometry.normal[0]) - (w[0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[2][0] - geometry.vertices[2][1]))/(24*geometry.normal[0]) - (w[0]*(geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[2][0] - geometry.vertices[2][2]))/(12*geometry.normal[0]);
        
    }
    
    else if (geometry.normal[1] != 0){
        
        M3[0] = (w[0]*(2*geometry.vertices[2][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]) - (2*geometry.vertices[1][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]))/6.0 - (w[0]*(pow((geometry.vertices[2][0] - geometry.vertices[2][2]),2) + pow((geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])),2)/pow(geometry.normal[1],2)))/12.0 - (w[0]*(pow((geometry.vertices[2][0] - geometry.vertices[2][1]),2) + pow((geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])),2)/pow(geometry.normal[1],2)))/12.0 + (w[0]*(2*geometry.vertices[2][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]) - (2*geometry.vertices[1][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]))/6.0 - (w[0]*(2*(geometry.vertices[2][0] - geometry.vertices[2][1])*(geometry.vertices[2][0] - geometry.vertices[2][2]) + (2*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/pow(geometry.normal[1],2)))/24.0 - (w[0]*(pow(geometry.vertices[1][0],2) + pow(geometry.vertices[2][0],2)))/2.0 + (w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[2][0] - geometry.vertices[2][1]))/12.0 + (w[2]*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[2][0] - geometry.vertices[2][2]))/24.0 + (w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2])*(geometry.vertices[2][0] - geometry.vertices[2][1]))/24.0 + (w[2]*(geometry.vertices[0][0] - geometry.vertices[0][2])*(geometry.vertices[2][0] - geometry.vertices[2][2]))/12.0 + (w[1]*geometry.vertices[0][0]*geometry.vertices[1][0])/2.0 + (w[2]*geometry.vertices[0][0]*geometry.vertices[2][0])/2.0 - (w[1]*geometry.vertices[1][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]))/6.0 - (w[1]*geometry.vertices[1][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]))/6.0 - (w[2]*geometry.vertices[2][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]))/6.0 - (w[2]*geometry.vertices[2][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]))/6.0 - (w[2]*geometry.vertices[0][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))/6.0 - (w[2]*geometry.vertices[0][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))/6.0 + (w[1]*geometry.vertices[0][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/(6*geometry.normal[1]) + (w[1]*geometry.vertices[0][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/(6*geometry.normal[1]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[0][0] - geometry.vertices[0][1]))/(12*geometry.normal[1]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[0][0] - geometry.vertices[0][2]))/(24*geometry.normal[1]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[0][0] - geometry.vertices[0][1]))/(24*geometry.normal[1]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[0][0] - geometry.vertices[0][2]))/(12*geometry.normal[1]);
        
        M3[1] = (w[1]*(2*geometry.vertices[0][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + 2*geometry.vertices[2][0]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/6.0 + (w[1]*(2*geometry.vertices[0][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + 2*geometry.vertices[2][0]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/6.0 - (w[1]*(pow((geometry.vertices[0][0] - geometry.vertices[0][1]),2) + pow((geometry.vertices[2][0] - geometry.vertices[2][1]),2)))/12.0 - (w[1]*(pow((geometry.vertices[0][0] - geometry.vertices[0][2]),2) + pow((geometry.vertices[2][0] - geometry.vertices[2][2]),2)))/12.0 - (w[1]*(2*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[0][0] - geometry.vertices[0][2]) + 2*(geometry.vertices[2][0] - geometry.vertices[2][1])*(geometry.vertices[2][0] - geometry.vertices[2][2])))/24.0 - (w[1]*(pow(geometry.vertices[0][0],2) + pow(geometry.vertices[2][0],2)))/2.0 + (w[0]*geometry.vertices[0][0]*geometry.vertices[1][0])/2.0 + (w[2]*geometry.vertices[1][0]*geometry.vertices[2][0])/2.0 - (w[0]*geometry.vertices[1][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]))/6.0 - (w[0]*geometry.vertices[1][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]))/6.0 - (w[2]*geometry.vertices[1][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))/6.0 - (w[2]*geometry.vertices[1][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))/6.0 + (w[0]*geometry.vertices[0][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/(6*geometry.normal[1]) + (w[0]*geometry.vertices[0][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/(6*geometry.normal[1]) + (w[2]*geometry.vertices[2][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/(6*geometry.normal[1]) + (w[2]*geometry.vertices[2][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/(6*geometry.normal[1]) - (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[0][0] - geometry.vertices[0][1]))/(12*geometry.normal[1]) - (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[0][0] - geometry.vertices[0][2]))/(24*geometry.normal[1]) - (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[0][0] - geometry.vertices[0][1]))/(24*geometry.normal[1]) - (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[0][0] - geometry.vertices[0][2]))/(12*geometry.normal[1]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[2][0] - geometry.vertices[2][1]))/(12*geometry.normal[1]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[2][0] - geometry.vertices[2][2]))/(24*geometry.normal[1]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[2][0] - geometry.vertices[2][1]))/(24*geometry.normal[1]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[2][0] - geometry.vertices[2][2]))/(12*geometry.normal[1]);
        
        M3[2] = (w[2]*(2*geometry.vertices[0][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - (2*geometry.vertices[1][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/geometry.normal[1]))/6.0 - (w[2]*(pow((geometry.vertices[0][0] - geometry.vertices[0][2]),2) + pow((geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])),2)/pow(geometry.normal[1],2)))/12.0 - (w[2]*(pow((geometry.vertices[0][0] - geometry.vertices[0][1]),2) + pow((geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])),2)/pow(geometry.normal[1],2)))/12.0 + (w[2]*(2*geometry.vertices[0][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - (2*geometry.vertices[1][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/geometry.normal[1]))/6.0 - (w[2]*(2*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (2*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/pow(geometry.normal[1],2)))/24.0 - (w[2]*(pow(geometry.vertices[0][0],2) + pow(geometry.vertices[1][0],2)))/2.0 + (w[0]*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[2][0] - geometry.vertices[2][1]))/12.0 + (w[0]*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[2][0] - geometry.vertices[2][2]))/24.0 + (w[0]*(geometry.vertices[0][0] - geometry.vertices[0][2])*(geometry.vertices[2][0] - geometry.vertices[2][1]))/24.0 + (w[0]*(geometry.vertices[0][0] - geometry.vertices[0][2])*(geometry.vertices[2][0] - geometry.vertices[2][2]))/12.0 + (w[0]*geometry.vertices[0][0]*geometry.vertices[2][0])/2.0 + (w[1]*geometry.vertices[1][0]*geometry.vertices[2][0])/2.0 - (w[0]*geometry.vertices[2][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]))/6.0 - (w[0]*geometry.vertices[2][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]))/6.0 - (w[0]*geometry.vertices[0][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))/6.0 - (w[0]*geometry.vertices[0][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))/6.0 - (w[1]*geometry.vertices[1][0]*(geometry.vertices[2][0] - geometry.vertices[2][1]))/6.0 - (w[1]*geometry.vertices[1][0]*(geometry.vertices[2][0] - geometry.vertices[2][2]))/6.0 + (w[1]*geometry.vertices[2][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1])))/(6*geometry.normal[1]) + (w[1]*geometry.vertices[2][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2])))/(6*geometry.normal[1]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[2][0] - geometry.vertices[2][1]))/(12*geometry.normal[1]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][1]))*(geometry.vertices[2][0] - geometry.vertices[2][2]))/(24*geometry.normal[1]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[2][0] - geometry.vertices[2][1]))/(24*geometry.normal[1]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[2]*(geometry.vertices[2][0] - geometry.vertices[2][2]))*(geometry.vertices[2][0] - geometry.vertices[2][2]))/(12*geometry.normal[1]);
        
    }
    
    else if (geometry.normal[2] != 0){
        
        M3[0] = (w[0]*(2*geometry.vertices[1][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]) - (2*geometry.vertices[2][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]))/6.0 - (w[0]*(pow((geometry.vertices[1][0] - geometry.vertices[1][2]),2) + pow((geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])),2)/pow(geometry.normal[2],2)))/12.0 - (w[0]*(pow((geometry.vertices[1][0] - geometry.vertices[1][1]),2) + pow((geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])),2)/pow(geometry.normal[2],2)))/12.0 + (w[0]*(2*geometry.vertices[1][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]) - (2*geometry.vertices[2][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]))/6.0 - (w[0]*(2*(geometry.vertices[1][0] - geometry.vertices[1][1])*(geometry.vertices[1][0] - geometry.vertices[1][2]) + (2*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/pow(geometry.normal[2],2)))/24.0 - (w[0]*(pow(geometry.vertices[1][0],2) + pow(geometry.vertices[2][0],2)))/2.0 + (w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[1][0] - geometry.vertices[1][1]))/12.0 + (w[1]*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[1][0] - geometry.vertices[1][2]))/24.0 + (w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2])*(geometry.vertices[1][0] - geometry.vertices[1][1]))/24.0 + (w[1]*(geometry.vertices[0][0] - geometry.vertices[0][2])*(geometry.vertices[1][0] - geometry.vertices[1][2]))/12.0 + (w[1]*geometry.vertices[0][0]*geometry.vertices[1][0])/2.0 + (w[2]*geometry.vertices[0][0]*geometry.vertices[2][0])/2.0 - (w[1]*geometry.vertices[1][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]))/6.0 - (w[1]*geometry.vertices[1][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]))/6.0 - (w[1]*geometry.vertices[0][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))/6.0 - (w[1]*geometry.vertices[0][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))/6.0 - (w[2]*geometry.vertices[2][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]))/6.0 - (w[2]*geometry.vertices[2][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]))/6.0 + (w[2]*geometry.vertices[0][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/(6*geometry.normal[2]) + (w[2]*geometry.vertices[0][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/(6*geometry.normal[2]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.vertices[0][0] - geometry.vertices[0][1]))/(12*geometry.normal[2]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.vertices[0][0] - geometry.vertices[0][2]))/(24*geometry.normal[2]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.vertices[0][0] - geometry.vertices[0][1]))/(24*geometry.normal[2]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.vertices[0][0] - geometry.vertices[0][2]))/(12*geometry.normal[2]);
        
        M3[1] = (w[1]*(2*geometry.vertices[0][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) - (2*geometry.vertices[2][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/geometry.normal[2]))/6.0 - (w[1]*(pow((geometry.vertices[0][0] - geometry.vertices[0][2]),2) + pow((geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])),2)/pow(geometry.normal[2],2)))/12.0 - (w[1]*(pow((geometry.vertices[0][0] - geometry.vertices[0][1]),2) + pow((geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])),2)/pow(geometry.normal[2],2)))/12.0 + (w[1]*(2*geometry.vertices[0][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) - (2*geometry.vertices[2][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/geometry.normal[2]))/6.0 - (w[1]*(2*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[0][0] - geometry.vertices[0][2]) + (2*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/pow(geometry.normal[2],2)))/24.0 - (w[1]*(pow(geometry.vertices[0][0],2) + pow(geometry.vertices[2][0],2)))/2.0 + (w[0]*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[1][0] - geometry.vertices[1][1]))/12.0 + (w[0]*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[1][0] - geometry.vertices[1][2]))/24.0 + (w[0]*(geometry.vertices[0][0] - geometry.vertices[0][2])*(geometry.vertices[1][0] - geometry.vertices[1][1]))/24.0 + (w[0]*(geometry.vertices[0][0] - geometry.vertices[0][2])*(geometry.vertices[1][0] - geometry.vertices[1][2]))/12.0 + (w[0]*geometry.vertices[0][0]*geometry.vertices[1][0])/2.0 + (w[2]*geometry.vertices[1][0]*geometry.vertices[2][0])/2.0 - (w[0]*geometry.vertices[1][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]))/6.0 - (w[0]*geometry.vertices[1][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]))/6.0 - (w[0]*geometry.vertices[0][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))/6.0 - (w[0]*geometry.vertices[0][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))/6.0 - (w[2]*geometry.vertices[2][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))/6.0 - (w[2]*geometry.vertices[2][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))/6.0 + (w[2]*geometry.vertices[1][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/(6*geometry.normal[2]) + (w[2]*geometry.vertices[1][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/(6*geometry.normal[2]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.vertices[1][0] - geometry.vertices[1][1]))/(12*geometry.normal[2]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.vertices[1][0] - geometry.vertices[1][2]))/(24*geometry.normal[2]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.vertices[1][0] - geometry.vertices[1][1]))/(24*geometry.normal[2]) - (w[2]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.vertices[1][0] - geometry.vertices[1][2]))/(12*geometry.normal[2]);
        
        M3[2] = (w[2]*(2*geometry.vertices[0][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + 2*geometry.vertices[1][0]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/6.0 + (w[2]*(2*geometry.vertices[0][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + 2*geometry.vertices[1][0]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/6.0 - (w[2]*(pow((geometry.vertices[0][0] - geometry.vertices[0][1]),2) + pow((geometry.vertices[1][0] - geometry.vertices[1][1]),2)))/12.0 - (w[2]*(pow((geometry.vertices[0][0] - geometry.vertices[0][2]),2) + pow((geometry.vertices[1][0] - geometry.vertices[1][2]),2)))/12.0 - (w[2]*(2*(geometry.vertices[0][0] - geometry.vertices[0][1])*(geometry.vertices[0][0] - geometry.vertices[0][2]) + 2*(geometry.vertices[1][0] - geometry.vertices[1][1])*(geometry.vertices[1][0] - geometry.vertices[1][2])))/24.0 - (w[2]*(pow(geometry.vertices[0][0],2) + pow(geometry.vertices[1][0],2)))/2.0 + (w[0]*geometry.vertices[0][0]*geometry.vertices[2][0])/2.0 + (w[1]*geometry.vertices[1][0]*geometry.vertices[2][0])/2.0 - (w[0]*geometry.vertices[2][0]*(geometry.vertices[0][0] - geometry.vertices[0][1]))/6.0 - (w[0]*geometry.vertices[2][0]*(geometry.vertices[0][0] - geometry.vertices[0][2]))/6.0 - (w[1]*geometry.vertices[2][0]*(geometry.vertices[1][0] - geometry.vertices[1][1]))/6.0 - (w[1]*geometry.vertices[2][0]*(geometry.vertices[1][0] - geometry.vertices[1][2]))/6.0 + (w[0]*geometry.vertices[0][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/(6*geometry.normal[2]) + (w[0]*geometry.vertices[0][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/(6*geometry.normal[2]) + (w[1]*geometry.vertices[1][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1])))/(6*geometry.normal[2]) + (w[1]*geometry.vertices[1][0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2])))/(6*geometry.normal[2]) - (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.vertices[0][0] - geometry.vertices[0][1]))/(12*geometry.normal[2]) - (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.vertices[0][0] - geometry.vertices[0][2]))/(24*geometry.normal[2]) - (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.vertices[0][0] - geometry.vertices[0][1]))/(24*geometry.normal[2]) - (w[0]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.vertices[0][0] - geometry.vertices[0][2]))/(12*geometry.normal[2]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.vertices[1][0] - geometry.vertices[1][1]))/(12*geometry.normal[2]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][1]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][1]))*(geometry.vertices[1][0] - geometry.vertices[1][2]))/(24*geometry.normal[2]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.vertices[1][0] - geometry.vertices[1][1]))/(24*geometry.normal[2]) - (w[1]*(geometry.normal[0]*(geometry.vertices[0][0] - geometry.vertices[0][2]) + geometry.normal[1]*(geometry.vertices[1][0] - geometry.vertices[1][2]))*(geometry.vertices[1][0] - geometry.vertices[1][2]))/(12*geometry.normal[2]);
        
    }
    
    for (int i=0; i<3; i++)
        M3[i] = M3[i]*rho*J*dotprod(geometry.normal,v)*Cd/2.0;
    
    ////////// SUM UP TERMS
    for (int i=0; i<3; i++)
        g[i] = M1[i] + M2[i] + M3[i];
    
}
